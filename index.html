<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§¤ìŠ¤ í€˜ìŠ¤íŠ¸</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #F0F8FF; margin: 0; padding: 20px; text-align: center; }
        .hidden { display: none; }
        .btn { background-color: #4CAF50; color: white; border: none; padding: 15px; width: 100%; max-width: 320px; margin: 10px auto; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; display: block; }
        .btn-reset { background-color: #dc3545; width: 150px; }
        .btn-submit { background-color: #007BFF; width: 160px; }
        input[type="number"] { width: 180px; padding: 15px; font-size: 28px; text-align: center; margin: 20px 0; border: 2px solid #ccc; border-radius: 8px; }
        #timer { color: #dc3545; font-size: 26px; font-weight: bold; }
        #info { color: #0056b3; font-size: 16px; font-weight: bold; margin-bottom: 20px; }
        #question { font-size: 36px; font-weight: bold; margin: 30px 0; white-space: pre-line; }
        #feedback { font-size: 18px; font-weight: bold; height: 30px; }
    </style>
</head>
<body>

    <div id="view-selection">
        <h2>ğŸ“š í€˜ìŠ¤íŠ¸ ë“±ê¸‰ ì„ íƒ</h2>
        <div id="grade-buttons"></div>
        <br><br>
        <button class="btn btn-reset" onclick="resetRecords()">ğŸ—‘ ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>

    <div id="view-play" class="hidden">
        <div id="timer">â± 0.0ì´ˆ</div>
        <div id="info"></div>
        <div id="question"></div>
        <input type="number" id="answer-input" inputmode="decimal" placeholder="?">
        <button class="btn btn-submit" id="submit-btn" onclick="checkAnswer()">ì •ë‹µ í™•ì¸</button>
        <div id="feedback"></div>
    </div>

    <div id="view-result" class="hidden">
        <h1 id="result-title" style="margin-top: 50px;"></h1>
        <p id="result-desc" style="font-size: 20px;"></p>
        <h3 id="result-time"></h3>
        <button class="btn btn-submit" id="next-btn"></button>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('mathQuestRecords')) || 
                      {1: {level: 0, best_time: 0}, 2: {level: 0, best_time: 0}, 3: {level: 0, best_time: 0}, 4: {level: 0, best_time: 0}, 5: {level: 0, best_time: 0}, 6: {level: 0, best_time: 0}};
        
        let grade, level, q_num, correct_count, answer, startTime, timerInterval, lastQuestion = "";

        function saveRecords() { localStorage.setItem('mathQuestRecords', JSON.stringify(records)); }

        function showSelection() {
            document.getElementById('view-selection').classList.remove('hidden');
            document.getElementById('view-play').classList.add('hidden');
            document.getElementById('view-result').classList.add('hidden');
            
            const btnContainer = document.getElementById('grade-buttons');
            btnContainer.innerHTML = '';
            for(let i=1; i<=6; i++) {
                let rec = records[i];
                let best = rec.best_time > 0 ? ` / ${rec.best_time}ì´ˆ` : '';
                btnContainer.innerHTML += `<button class="btn" onclick="startGame(${i})">ì´ˆë“± ${i}í•™ë…„ (Lv.${rec.level} ì™„ë£Œ${best})</button>`;
            }
        }

        function resetRecords() {
            if(confirm("ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) {
                records = {1: {level: 0, best_time: 0}, 2: {level: 0, best_time: 0}, 3: {level: 0, best_time: 0}, 4: {level: 0, best_time: 0}, 5: {level: 0, best_time: 0}, 6: {level: 0, best_time: 0}};
                saveRecords(); showSelection();
            }
        }

        function startGame(g) {
            grade = g;
            level = Math.min(records[g].level + 1, 20);
            initLevel();
        }

        function initLevel() {
            q_num = 1; correct_count = 0; lastQuestion = "";
            document.getElementById('view-selection').classList.add('hidden');
            document.getElementById('view-result').classList.add('hidden');
            document.getElementById('view-play').classList.remove('hidden');
            
            startTime = Date.now();
            timerInterval = setInterval(() => {
                document.getElementById('timer').innerText = `â± ${((Date.now() - startTime)/1000).toFixed(1)}ì´ˆ`;
            }, 100);
            
            setQuestion();
        }

        function setQuestion() {
            document.getElementById('answer-input').value = '';
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('feedback').innerText = '';
            document.getElementById('info').innerText = `[${grade}í•™ë…„] ğŸš© ${level}/20ë‹¨ê³„ | ğŸ“ ${q_num}/10 | â­• ${correct_count}ê°œ`;
            
            let qData = generateQuestion();
            document.getElementById('question').innerText = qData.q;
            answer = qData.a;
            document.getElementById('answer-input').focus();
        }

        function generateQuestion() {
            let q_str, ans;
            let lvl = level;
            while(true) {
                let type_sel = Math.floor(Math.random() * 3) + 1;
                if(grade === 1) {
                    let limit = 9 + lvl;
                    let a = Math.floor(Math.random() * limit) + 1;
                    let b = Math.floor(Math.random() * limit) + 1;
                    if(type_sel === 1) { q_str = `${a} + ${b} = ?`; ans = a + b; }
                    else if(type_sel === 2) { if(a<b) [a,b] = [b,a]; q_str = `${a} - ${b} = ?`; ans = a - b; }
                    else { q_str = `${a} + ? = ${a+b}`; ans = b; }
                } 
                // JS ë³€í™˜: ì•„ë²„ë‹˜ì˜ 2~6í•™ë…„ ë¡œì§ë„ ë¸Œë¼ìš°ì € ìš©ìœ¼ë¡œ ë‹¨ìˆœí™”í•˜ì—¬ ë™ì¼í•˜ê²Œ ì ìš©
                else {
                    let a = Math.floor(Math.random() * (10 + grade*5)) + 2;
                    let b = Math.floor(Math.random() * 9) + 2;
                    if(grade % 2 === 0) { q_str = `${a} x ${b} = ?`; ans = a * b; }
                    else { q_str = `${a*b} Ã· ${b} = ?`; ans = a; }
                }
                
                if(q_str !== lastQuestion) { lastQuestion = q_str; return {q: q_str, a: ans}; }
            }
        }

        function checkAnswer() {
            let userVal = parseFloat(document.getElementById('answer-input').value);
            if(isNaN(userVal)) { document.getElementById('feedback').innerText = "âš ï¸ ìˆ«ìë§Œ ì…ë ¥!"; document.getElementById('feedback').style.color = "red"; return; }
            
            document.getElementById('submit-btn').disabled = true;
            if(Math.abs(userVal - answer) < 0.01) {
                correct_count++;
                document.getElementById('feedback').innerText = "â­• ë”©ë™ëŒ•! í›Œë¥­í•´ìš”!";
                document.getElementById('feedback').style.color = "#28a745";
            } else {
                document.getElementById('feedback').innerText = `âŒ ì˜¤ë‹µ (ì •ë‹µ: ${answer})`;
                document.getElementById('feedback').style.color = "#dc3545";
            }
            
            q_num++;
            if(q_num > 10) { clearInterval(timerInterval); setTimeout(showResult, 1000); }
            else { setTimeout(setQuestion, 1000); }
        }

        function showResult() {
            document.getElementById('view-play').classList.add('hidden');
            document.getElementById('view-result').classList.remove('hidden');
            let clearTime = ((Date.now() - startTime)/1000).toFixed(1);
            
            let title = document.getElementById('result-title');
            let desc = document.getElementById('result-desc');
            let timeLbl = document.getElementById('result-time');
            let btn = document.getElementById('next-btn');
            
            if(correct_count >= 8) {
                title.innerText = `âœ¨ ${level}ë‹¨ê³„ í†µê³¼! âœ¨`; title.style.color = "#28a745";
                desc.innerText = "";
                let rec = records[grade];
                if(level > rec.level) rec.level = level;
                
                timeLbl.innerText = `â± ì†Œìš” ì‹œê°„: ${clearTime}ì´ˆ`;
                if(rec.best_time === 0 || clearTime < rec.best_time) {
                    rec.best_time = parseFloat(clearTime);
                    timeLbl.innerText += " (ğŸ‰ ìµœê³  ê¸°ë¡!)"; timeLbl.style.color = "#d63384";
                } else { timeLbl.style.color = "#6c757d"; }
                saveRecords();
                
                btn.innerText = "ë‹¤ìŒ í€˜ìŠ¤íŠ¸ ë„ì „";
                btn.onclick = () => { level++; initLevel(); };
            } else {
                title.innerText = "ğŸ’§ í†µê³¼ ì‹¤íŒ¨ ğŸ’§"; title.style.color = "#dc3545";
                desc.innerText = `ì„±ì : ${correct_count}ê°œ / 10ê°œ (8ê°œ ì´ìƒ í†µê³¼)`;
                timeLbl.innerText = "";
                btn.innerText = "ë‹¤ì‹œ ë„ì „";
                btn.onclick = () => { initLevel(); };
            }
        }

        showSelection();
    </script>
</body>
</html>
